<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ashley Nilson">
        <link rel="canonical" href="https://ash-nil.github.io/Database_Updates/Database_Updates/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Database Updates-Validation (SQL) - Ashley Nilson</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
            <div class="container">
                <a class="navbar-brand" href="../..">Ashley Nilson</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Current Project</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Marketing_Campaign_Results/analysis_pt1/" class="dropdown-item">Marketing Campaign Results (Python)</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Past Projects</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../Traffic_Analysis/Traffic_Analysis/" class="dropdown-item">Traffic Analysis (Python)</a>
</li>
                                    
<li>
    <a href="../../Fraudulent_Acct_Detection/Fraudulent_Acct_Detection/" class="dropdown-item">Fraudulent Account Detection (Python)</a>
</li>
                                    
<li>
    <a href="../../Game_AB_Testing/Game_AB_Testing/" class="dropdown-item">AB Game Testing (Python)</a>
</li>
                                    
<li>
    <a href="../../EV_Charging_Optimization/EV_Charging_Optimization/" class="dropdown-item">EV Charging Optimization (R)</a>
</li>
                                    
<li>
    <a href="../../Housing_Price_Prediction/Housing_Price_Prediction/" class="dropdown-item">Housing Price Prediction (R)</a>
</li>
                                    
<li>
    <a href="../Database_Updates_PR/" class="dropdown-item">Database Updates-PR (SQL)</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Database Updates-Validation (SQL)</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Accounting Reports</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../HBR_Reports/Asante/" class="dropdown-item">Asante Teaching Hospital Billing</a>
</li>
                                    
<li>
    <a href="../../HBR_Reports/Danshui/" class="dropdown-item">Danshui Plant Manufacturing</a>
</li>
                                    
<li>
    <a href="../../HBR_Reports/LondonWater/" class="dropdown-item">London Water Pricing</a>
</li>
                                    
<li>
    <a href="../../HBR_Reports/PolicePricing/" class="dropdown-item">Police Billing Structure</a>
</li>
                                    
<li>
    <a href="../../HBR_Reports/TidalCloud/" class="dropdown-item">Tidal Cloud Accounting</a>
</li>
                                    
<li>
    <a href="../../HBR_Reports/Toliza/" class="dropdown-item">Toliza Museum of Art Admission</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Database_Updates_PR/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../../HBR_Reports/Asante/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="true">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#database-updates-validation" class="nav-link">Database Updates - Validation</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#establish-database-tables" class="nav-link">Establish database &amp; tables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#run-stored-procedure-compare" class="nav-link">Run stored procedure &amp; compare</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#rerun-stored-procedure" class="nav-link">Rerun stored procedure</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="database-updates-validation">Database Updates - Validation</h1>
<h2 id="establish-database-tables">Establish database &amp; tables</h2>
<pre><code class="language-sql">-- setup database
CREATE DATABASE Customer;
SHOW DATABASES;
USE Customer;

-- setup staging table
CREATE TABLE Customer.CustomerChurn_Stage (
CustomerId INT PRIMARY KEY,
Surname VARCHAR(50),
CreditScore SMALLINT,
Geography VARCHAR(50),
Gender VARCHAR(15),
Age TINYINT,
Balance DECIMAL(10,2),
Exited TINYINT
);
DESCRIBE Customer.CustomerChurn_Stage;

-- setup persistent table
CREATE TABLE Customer.CustomerChurn (
CustomerId INT PRIMARY KEY,
Surname VARCHAR(50),
CreditScore SMALLINT,
Geography VARCHAR(50),
Gender VARCHAR(15),
Age TINYINT,
Balance DECIMAL(10,2),
Exited TINYINT,
SourceSystemNm CHAR(20) NOT NULL,
CreateAgentId CHAR(20) NOT NULL,
CreateDtm DATETIME NOT NULL,
ChangeAgentId CHAR(20) NOT NULL,
ChangeDtm DATETIME NOT NULL);
DESCRIBE Customer.CustomerChurn;
-- get row count from stage table
SELECT COUNT(*) FROM Customer.CustomerChurn_Stage;

-- get last rows from stage
SELECT * FROM Customer.CustomerChurn_Stage
ORDER BY CustomerID DESC LIMIT 3;
</code></pre>
<h2 id="run-stored-procedure-compare">Run stored procedure &amp; compare</h2>
<pre><code class="language-sql">-- call procedure
CALL `Customer`.`Customer.PrCustomerChurn`();

-- confirm row counts
SELECT COUNT(*) AS 'Persistent Table Rows' 
FROM Customer.CustomerChurn;
SELECT COUNT(*) AS 'Staging Table Rows' 
FROM Customer.CustomerChurn_Stage;

-- get last rows from persistent
SELECT * FROM Customer.CustomerChurn
ORDER BY CustomerID DESC LIMIT 3;

-- create new table duplicating persistent table as V1
CREATE TABLE Customer.CustomerChurn_Version1 AS SELECT * FROM Customer.CustomerChurn;
DESCRIBE Customer.CustomerChurn_Version1;
SELECT COUNT(*) FROM Customer.CustomerChurn_Version1;
SELECT * FROM Customer.CustomerChurn_Version1
ORDER BY CustomerID DESC LIMIT 3;

-- empty the staging table
TRUNCATE TABLE Customer.CustomerChurn_Stage;
SELECT * FROM Customer.CustomerChurn_Stage;

-- row info from new data in staging
SELECT COUNT(*) FROM Customer.CustomerChurn_Stage;
SELECT * FROM Customer.CustomerChurn_Stage
ORDER BY CustomerID DESC LIMIT 3;
</code></pre>
<h2 id="rerun-stored-procedure">Rerun stored procedure</h2>
<pre><code class="language-sql">-- rerun PR
CALL `Customer`.`Customer.PrCustomerChurn`();

-- compare updated persistent to V1
SELECT COUNT(*) AS 'Persistent Table Rows' 
FROM Customer.CustomerChurn;
SELECT COUNT(*) AS 'Version 1 Table Rows' 
FROM Customer.CustomerChurn_Version1;

-- rows in V1 not in new persistent
SELECT * FROM Customer.CustomerChurn_Version1
LEFT JOIN Customer.CustomerChurn
ON CustomerChurn_Version1.CustomerId = CustomerChurn.CustomerId
WHERE CustomerChurn.CustomerId IS NULL
ORDER BY CustomerChurn_Version1.CustomerId;

-- rows updated between V1 and persistent
SELECT * FROM Customer.CustomerChurn_Version1
INNER JOIN Customer.CustomerChurn
ON CustomerChurn_Version1.CustomerId = CustomerChurn.CustomerId
WHERE CustomerChurn.Surname &lt;&gt; CustomerChurn_Version1.Surname
OR CustomerChurn.CreditScore &lt;&gt; CustomerChurn_Version1.CreditScore
OR CustomerChurn.Geography &lt;&gt; CustomerChurn_Version1.Geography
OR CustomerChurn.Gender &lt;&gt; CustomerChurn_Version1.Gender
OR CustomerChurn.Age &lt;&gt; CustomerChurn_Version1.Age
OR CustomerChurn.Balance &lt;&gt; CustomerChurn_Version1.Balance
OR CustomerChurn.Exited &lt;&gt; CustomerChurn_Version1.Exited
ORDER BY CustomerChurn_Version1.CustomerId;

-- last few rows from persistent
SELECT * FROM Customer.CustomerChurn
ORDER BY CustomerID DESC LIMIT 3;

-- rows in persistent that weren't in V1
SELECT * FROM Customer.CustomerChurn
LEFT JOIN Customer.CustomerChurn_Version1
ON CustomerChurn.CustomerId = CustomerChurn_Version1.CustomerId
WHERE CustomerChurn_Version1.CustomerId IS NULL
ORDER BY CustomerChurn.CustomerId;
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
